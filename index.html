<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>おわら風の盆｜決済 (LIFF)</title>

  <!-- LIFF v2 SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- UnivaPay Checkout Widget -->
  <script src="https://widget.univapay.com/client/checkout.js"></script>

  <style>
    body{font-family:sans-serif;text-align:center;padding:20px}
    #pay{font-size:1.4rem;padding:14px 32px;border:0;border-radius:6px;
         background:#007bff;color:#fff;cursor:pointer}
    #pay:disabled{opacity:.4;cursor:default}
    .status{margin-bottom:1rem;padding:.5rem;background:#f0f0f0;border-radius:4px}
  </style>
</head>
<body>
  <div id="status" class="status">LIFFを初期化中...</div>
  <button id="pay" disabled>おわら風の盆 有料メニュー (¥100)</button>

  <script>
    // ========= ① 固定値 =========
    const LIFF_ID           = '2007034467-z13l7loG';       // TODO: 正しい LIFF ID
    const UNIVAPAY_APP_ID   = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhcHBfdG9rZW4iLCJpYXQiOjE3NDg0OTQyMTEsIm1lcmNoYW50X2lkIjoiMTFmMDJlMTgtYzE1Ny0zOTk4LTk4NzgtY2I4N2ZlMzc3NjY4Iiwic3RvcmVfaWQiOiIxMWYwMmUxOC1lZjQ3LTQ5MWEtYWVjNy1iNzI4ZGQxNTM1NGMiLCJkb21haW5zIjpbImhhcnV0b2dvdG8uZ2l0aHViLmlvIl0sIm1vZGUiOiJ0ZXN0IiwiY3JlYXRvcl9pZCI6IjExZjAyZTE4LWMxNTctMzk5OC05ODc4LWNiODdmZTM3NzY2OCIsInZlcnNpb24iOjEsImp0aSI6IjExZjAzYzQ4LTY3NTktYjdhYi1hZjgwLWU3ZjdmZDU2ODQ1ZiJ9.virRF7QMEaez9Rof_vRcrGpb2CBtTDCD0vnlWpyGc_U';       // TODO: Checkout 用 JWT
    const BACKEND_ENDPOINT  = 'https://sabefmw7dl.execute-api.ap-northeast-1.amazonaws.com/prod/UnivaPayWebhookHandler'; // TODO: API

    // ========= ② 変数 =========
    let lineUserId  = null;
    let checkout    = null;

    // ========= ③ メイン =========
    window.addEventListener('DOMContentLoaded', async () => {
      const $status = document.getElementById('status');
      const $pay    = document.getElementById('pay');

      /* --- LIFF 初期化 --- */
      try {
        await liff.init({ liffId: LIFF_ID });
        $status.textContent = 'LIFF 初期化 OK';

        if (liff.isInClient()) {
          const profile = await liff.getProfile();
          lineUserId    = profile.userId;
          $status.textContent += ` (User: ${lineUserId})`;
        } else {
          $status.textContent += ' (LINE 外ブラウザ)';
        }

      } catch (err) {
        console.error('LIFF init error', err);
        $status.textContent = 'LIFF 初期化失敗: ' + err.message;
        return; // ここで中止
      }

      /* --- UnivaPay Checkout 準備 --- */
      checkout = UnivapayCheckout.create({
        appId      : UNIVAPAY_APP_ID,
        checkout   : 'payment',
        amount     : 100,               // ¥100
        currency   : 'jpy',
        title      : 'おわら風の盆｜決済',
        header     : 'おわら風の盆｜決済',
        description: '有料メニュー表示のための課金',
        metadata   : { line_user_id: lineUserId }, // ← Webhook 用
        onSuccess  : handlePaid,
        onError    : e => alert('決済失敗: ' + e.message),
      });

      /* --- ボタン有効化 & イベント割当 --- */
      $pay.disabled = false;
      $pay.addEventListener('click', () => checkout.open().catch(e=>{
        console.error('checkout.open エラー', e);
        alert('決済画面を開けませんでした');
      }));
    });

    // ========= ④ 決済成功コールバック =========
    async function handlePaid(result) {
      console.log('paid', result);

      try {
        const res = await fetch(BACKEND_ENDPOINT, {
          method : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body   : JSON.stringify({
            transactionToken: result.id,
            lineUserId
          })
        });
        const js = await res.json();
        console.log(res.status);
        console.log('backend:', js);
      } catch (e) {
        console.error('backend error', e);
      }

      // LINE アプリに戻す
      if (liff.isInClient()) liff.closeWindow();
      else alert('決済成功！ブラウザを閉じてください。');
      console.log('isInClient', liff.isInClient());
    }
  </script>
</body>
</html>
