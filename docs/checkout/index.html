<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>おわら風の盆｜お支払いに進んでいます</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;margin:0;padding:24px;text-align:center}
  .btn{display:inline-block;margin-top:16px;padding:10px 16px;border-radius:10px;background:#0d6efd;color:#fff;text-decoration:none}
  .note{color:#666;margin-top:12px}
</style>
</head>
<body>
  <h1>お支払いページを開いています…</h1>
  <p class="note">自動で開かない場合は下のボタンを押してください。</p>
  <a id="open" class="btn" href="javascript:void(0)">決済ページを開く</a>
  <p class="note">※外部ブラウザでカード/PayPayの決済を行います</p>

  <!-- ここにモジュールを入れる（docs/checkout から ../src/config.js を import） -->
  <script type="module">
    import {
      univapayAppId,      // JWT（config.js）
      univapayFormId,     // フォームID（config.js）
      siteBaseUrl,
      checkoutReturnPath
    } from "../src/config.js";

    const qs = new URLSearchParams(location.search);
    const amount     = Number(qs.get("amount") || "100");
    const liffId     = qs.get("liffId") || "";
    const lineUserId = qs.get("lu") || "";
    const state      = qs.get("state") || "";
    const currency   = "jpy";

    const base = `https://checkout.univapay.com/forms/${univapayFormId}`;

    const back = (ok) => {
      const u = new URL(siteBaseUrl + checkoutReturnPath);
      u.searchParams.set("ok", ok);           // 1=成功 0=失敗 2=保留
      if (liffId)     u.searchParams.set("liffId", liffId);
      if (lineUserId) u.searchParams.set("lu", lineUserId);
      if (state)      u.searchParams.set("state", state);
      return u.toString();
    };

    const hosted = new URL(base);
    const p = hosted.searchParams;
    p.set("appId", univapayAppId);
    p.set("checkout", "payment");
    p.set("amount", String(amount));
    p.set("currency", currency);
    p.set("paymentMethods", "card,pay_pay_online"); // カード＋PayPay
    p.set("successRedirectUrl", back("1"));
    p.set("failureRedirectUrl", back("0"));
    p.set("pendingRedirectUrl", back("2"));
    p.set("autoRedirect", "true");

    const go = () => location.replace(hosted.toString());
    document.getElementById("open").addEventListener("click", go);
    setTimeout(go, 300);
  </script>

  <noscript>このページを開くには JavaScript が必要です。</noscript>
</body>
</html>
