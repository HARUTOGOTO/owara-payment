<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>おわら風の盆｜お支払いに進んでいます</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;margin:0;padding:24px;text-align:center}
  .btn{display:inline-block;margin-top:16px;padding:10px 16px;border-radius:10px;background:#0d6efd;color:#fff;text-decoration:none}
  .btn.secondary{background:#445b79}
  .note{color:#666;margin-top:12px}
  #toLiff{display:none}
  /* debug時だけ出す簡易トースト（本番でも悪目立ちしない控えめデザイン）*/
  #status{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    background:#000c; color:#fff; padding:8px 12px; border-radius:12px;
    font-size:14px; display:none; z-index:9999; backdrop-filter:saturate(120%) blur(4px);
  }
</style>
</head>
<body>
  <h1>お支払いページを開いています…</h1>
  <p class="note">自動で開かない場合は下のボタンを押してください。</p>
  <a id="open"   class="btn" href="javascript:void(0)">決済ページを開く</a>
  <a id="toLiff" class="btn secondary" href="javascript:void(0)">ミニアプリに戻る</a>
  <p class="note">※外部ブラウザでカード/PayPayの決済を行います</p>

  <div id="status" aria-live="polite"></div>

  <!-- docs/checkout から ../src/config.js を import -->
  <script type="module">
  import { univapayAppId, univapayFormId, siteBaseUrl, checkoutReturnPath } from "../src/config.js";

  const qs = new URLSearchParams(location.search);
  const amount     = Number(qs.get("amount") || "100");
  const liffId     = qs.get("liffId") || "";
  const lineUserId = qs.get("lu") || "";
  const state      = qs.get("state") || "";
  const debug      = qs.get("debug") === "1";

  const showToast = (msg, ttl=2000) => {
    if (!debug) return;                     // 本番は邪魔しない（debug=1 の時だけ）
    const el = document.getElementById('status');
    el.textContent = msg; el.style.display = 'block';
    clearTimeout(showToast._t); showToast._t = setTimeout(()=> el.style.display='none', ttl);
  };

  const bindToLiff = (btn) => {
    if (!btn || btn.dataset.bound) return;
    btn.dataset.bound = '1';
    btn.addEventListener("click", () => {
      if (liffId) location.href = `https://liff.line.me/${encodeURIComponent(liffId)}`;
      else        location.href = "https://line.me/R/ti/p/@225hkxvw";
    });
  };

  const showBackBtn = () => {
    const b = document.getElementById("toLiff");
    if (!b) return;
    bindToLiff(b);
    b.style.display = "inline-block";
    showToast("ミニアプリに戻れます");
  };

  const back = (ok) => {
    const u = new URL(siteBaseUrl + checkoutReturnPath);
    u.searchParams.set("ok", ok); // 1=成功 0=失敗 2=保留
    if (liffId)     u.searchParams.set("liffId", liffId);
    if (lineUserId) u.searchParams.set("lu", lineUserId);
    if (state)      u.searchParams.set("state", state);
    if (debug)      u.searchParams.set("debug", "1");
    return u.toString();
  };

  // ★ 優先：サーバ発行の checkoutUrl（co）を使う。無ければ従来どおり自前組立て
  const co = qs.get("co");
  let hosted;
  if (co) {
    try { hosted = new URL(co); } catch {}
  }
  if (!hosted) {
    const base = `https://checkout.univapay.com/forms/${univapayFormId}`;
    hosted = new URL(base);
    const p = hosted.searchParams;
    p.set("appId", univapayAppId);
    p.set("checkout", "payment");
    p.set("amount", String(amount));
    p.set("currency", "jpy");
    p.set("paymentMethods", "card,pay_pay_online");
    p.set("successRedirectUrl", back("1"));
    p.set("failureRedirectUrl", back("0"));
    p.set("pendingRedirectUrl", back("2"));
    p.set("autoRedirect", "true");
  }

  // --- 初回だけ自動遷移。戻ってきたら自動では走らせない（無限ループ防止） ---
  const KEY = "owara_bridge_once";
  const go = () => { sessionStorage.setItem(KEY, "1"); location.href = hosted.toString(); };

  if (debug) {
    const pre = document.createElement('pre');
    pre.style.cssText = 'white-space:pre-wrap;background:#f4f8ff;color:#0d2847;padding:12px;border-radius:12px;text-align:left';
    pre.textContent = ['[bridge]', location.href, '', '[hosted]', hosted.toString(), '', '[ua]', navigator.userAgent].join('\n');
    document.body.appendChild(pre);
  }

  document.getElementById("open").addEventListener("click", go);

  if (sessionStorage.getItem(KEY) !== "1") {
    setTimeout(go, 300);
  } else {
    // 迷子時の救済UI：ミニアプリに戻るボタンを見せる
    showBackBtn();
  }

  // ★ フォーカス復帰（visibilitychange）や bfcache 戻り（pageshow persisted）でも即ボタンを出す
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && sessionStorage.getItem(KEY) === "1") {
      showBackBtn();
    }
  });
  window.addEventListener('pageshow', (e) => {
    if (e.persisted && sessionStorage.getItem(KEY) === "1") {
      showBackBtn();
    }
  });
</script>
  <noscript>このページを開くには JavaScript が必要です。</noscript>
</body>
</html>
